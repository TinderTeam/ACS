<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <link href="../../Script/demo.css" rel="stylesheet" type="text/css" />
    <script src="../../Scripts/boot.js" type="text/javascript"></script>
    <style type="text/css">
        html, body
        {
            margin: 0;
            padding: 0;
            border: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
    </style>

</head>
<body>
    <div class="mini-fit">
        <div id="tabs1" class="mini-tabs" activeindex="0" style="width: 100%; height: 100%;">
            <div title="根据权限选择">

                <div id="treegrid1" class="mini-treegrid" style="width: 100%; height: 93%;" 
                    showTreeIcon="true" treeColumn="taskname" idField="Id" parentField="Pid" checkedField="CheckNode"
                    resultAsTree="false" allowResize="true" showCheckBox="true" onbeforenodecheck="onBeforeNodeCheck">
                    <div property="columns">
                        <div type="indexcolumn"></div>
                        <div name="taskname" field="NodeName" width="120" headeralign="center" allowsort="true">权限名称</div>
                        <div field="Type" width="80" headeralign="center" allowsort="true">类型</div>
                        <div header="门禁时间" headeralign="center">
                            <div property="columns" >
                                <div field="StartTime" width="80" headeralign="center" dateFormat="HH:mm:ss" allowsort="true">开始时间</div>
                                <div field="EndTime" width="80" headeralign="center" dateFormat="HH:mm:ss" allowsort="true">截止时间</div>
                                <div field="Monday" width="30" headerAlign="center" renderer ="onYesRenderer">星期一</div>
                                <div field="Tuesday" width="30" headerAlign="center" renderer ="onYesRenderer">星期二</div>
                                <div field="Wednesday" width="30" headerAlign="center" renderer ="onYesRenderer">星期三</div>
                                <div field="Thursday" width="30" headerAlign="center" renderer ="onYesRenderer">星期四</div>
                                <div field="Friday" width="30" headerAlign="center" renderer ="onYesRenderer">星期五</div>
                                <div field="Saturday" width="30" headerAlign="center" renderer ="onYesRenderer">星期六</div>
                                <div field="Sunday" width="30" headerAlign="center" renderer ="onYesRenderer">星期日</div>
                                <div field="Holiday" width="30" headerAlign="center" renderer ="onYesRenderer">假期</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; padding: 5px;">
                    <a class="mini-button" onclick="onSaveData('AccessSubmit')"  style="width: 60px; margin-right: 20px;">确定</a>
                    <a class="mini-button" onclick="CloseWindow('cancel')" style="width: 60px;">取消</a>
                </div>

            </div>

            <div title="根据设备选择" iconcls="icon-cut">
                <div id="devicetreegrid" class="mini-treegrid" style="width: 100%; height: 93%;" 
                    showTreeIcon="true" treeColumn="taskname" idField="Id" parentField="Pid" checkedField="CheckNode"
                    resultAsTree="false" allowResize="true" showCheckBox="true">
                    <div property="columns">
                        <div type="indexcolumn"></div>
                        <div name="taskname" field="NodeName" width="120" headeralign="center" allowsort="true">权限名称</div>
                        <div field="Type" width="80" headeralign="center" allowsort="true">类型</div>
                        <div header="门禁时间" headeralign="center">
                            <div property="columns" >
                                <div field="StartTime" width="80" headeralign="center" dateFormat="HH:mm:ss" allowsort="true">开始时间</div>
                                <div field="EndTime" width="80" headeralign="center" dateFormat="HH:mm:ss" allowsort="true">截止时间</div>
                                <div field="Monday" width="30" headerAlign="center" renderer ="onYesRenderer">星期一</div>
                                <div field="Tuesday" width="30" headerAlign="center" renderer ="onYesRenderer">星期二</div>
                                <div field="Wednesday" width="30" headerAlign="center" renderer ="onYesRenderer">星期三</div>
                                <div field="Thursday" width="30" headerAlign="center" renderer ="onYesRenderer">星期四</div>
                                <div field="Friday" width="30" headerAlign="center" renderer ="onYesRenderer">星期五</div>
                                <div field="Saturday" width="30" headerAlign="center" renderer ="onYesRenderer">星期六</div>
                                <div field="Sunday" width="30" headerAlign="center" renderer ="onYesRenderer">星期日</div>
                                <div field="Holiday" width="30" headerAlign="center" renderer ="onYesRenderer">假期</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; padding: 5px;">
                    <a class="mini-button" onclick="onSaveData('DeviceSubmit')"  style="width: 60px; margin-right: 20px;">确定</a>
                    <a class="mini-button" onclick="CloseWindow('cancel')" style="width: 60px;">取消</a>
                </div>
            </div>

        </div>
    </div>
</body>
<script type="text/javascript">

    mini.parse();
    function onYesRenderer(e) {
        if (e.value == 1) return "*";
        else return "";
    }
    //加载窗口信息
    function Show(data) {
        //跨页面传递的数据对象，克隆后才可以安全使用
        receiveData = mini.clone(data);
        var treeGrid = mini.get("#treegrid1");
        //treeGrid.load("../Test/tasks.txt");
        treeGrid.load("LoadAddAccessDetail?selectedID=" + receiveData.id);

        var devicetreeGrid = mini.get("#devicetreegrid");
        devicetreeGrid.load("LoadDeviceTreeList?selectedID=" + receiveData.id);
    }
    //增加权限时，只能选择根节点，或者选中权限的子节点
    function onBeforeNodeCheck(e) {
        var text = mini.encode(e.node);
        if (e.node._level != 0) {
            e.cancel = true;
            mini.alert("请选择一个根节点");
        }
    }
    function onSaveData(type) {
        //获取操作类型（新建/修改）
        var url;
        var treeGrid;
        var node;
        var json;
        if (type == 'AccessSubmit') {
            //新建
            url = "../AccessManage/AddAccessOfAccess?accessID=" + receiveData.id;
            treeGrid = mini.get("#treegrid1");
            node = treeGrid.getCheckedNodes();
            json = mini.encode(node);
        }
        else if (type == 'DeviceSubmit') {
            //编辑
            url = "../AccessManage/AddDeviceOfAccess?accessID=" + receiveData.id;
            treeGrid = mini.get("#devicetreegrid");
            node = treeGrid.getCheckedNodes();
            json = mini.encode(node);
        }
            $.ajax({
                url: url,
                type: 'post',
                data: { data: json },
                cache: false,
                success: function (json) {
                    var Rsp = mini.decode(json);
                    if (Rsp.ErrorCode == "Success") {
                        CloseWindow("ok");
                    }
                    else {
                        alert(Rsp.Message);
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    alert(jqXHR.responseText);
                    CloseWindow();
                }
            });

    }

    function CloseWindow(action) {
        if (window.CloseOwnerWindow) return window.CloseOwnerWindow(action);
        else window.close();
    }
</script>

</html>
