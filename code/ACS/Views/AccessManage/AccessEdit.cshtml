<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <link href="../../Script/demo.css" rel="stylesheet" type="text/css" />
    <script src="../../Scripts/boot.js" type="text/javascript"></script>
    <style type="text/css">
        html, body
        {
            margin: 0;
            padding: 0;
            border: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
    </style>

</head>
<body>
    <div class="mini-fit">
        <div id="tabs1" class="mini-tabs" activeindex="0" style="width: 100%; height: 100%;">
            <div title="根据权限选择">

                <div id="treegrid1" class="mini-treegrid" style="width: 100%; height: 95%;" 
                    showTreeIcon="true" treeColumn="taskname" idField="Id" parentField="Pid"
                    resultAsTree="false" allowResize="true" expandOnLoad="true">
                    <div property="columns">
                        <div type="indexcolumn"></div>
                        <div name="taskname" field="Text" width="120" headeralign="center" allowsort="true">权限名称</div>
                        <div field="" width="120" headeralign="center" allowsort="true">序号</div>
                        <div field="Type" width="120" headeralign="center" allowsort="true">类型</div>
                        <div header="门禁时间" headeralign="center">
                            <div property="columns" >
                                <div field="CreateUserID" width="120" headeralign="center" allowsort="true">控制器名称</div>
                                <div field="CreateDate" width="120" headeralign="center" allowsort="true">门名称</div>
                                <div field="CreateDate" width="120" headeralign="center" allowsort="true">时间段编号</div>
                                <div field="StartTime" width="120" headeralign="center" allowsort="true">开始时间</div>
                                <div field="EndTime" width="120" headeralign="center" allowsort="true">截止时间</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; padding: 5px;">
                    <a class="mini-button" onclick="SaveAccessData('AccessSubmit')"  style="width: 60px; margin-right: 20px;">确定</a>
                    <a class="mini-button" onclick="onCancel" style="width: 60px;">取消</a>
                </div>

            </div>

            <div title="根据设备选择" iconcls="icon-cut">
                <div id="devicetreegrid" class="mini-treegrid" style="width: 100%; height: 95%;" 
                    showTreeIcon="true" treeColumn="taskname" idField="Id" parentField="Pid"
                    resultAsTree="false" allowResize="true" expandOnLoad="true" showCheckBox="true">
                    <div property="columns">
                        <div type="indexcolumn"></div>
                        <div name="taskname" field="Text" width="120" headeralign="center" allowsort="true">权限名称</div>
                        <div field="" width="120" headeralign="center" allowsort="true">序号</div>
                        <div field="Type" width="120" headeralign="center" allowsort="true">类型</div>
                        <div header="门禁时间" headeralign="center">
                            <div property="columns" >
                                <div field="CreateUserID" width="120" headeralign="center" allowsort="true">控制器名称</div>
                                <div field="CreateDate" width="120" headeralign="center" allowsort="true">门名称</div>
                                <div field="CreateDate" width="120" headeralign="center" allowsort="true">时间段编号</div>
                                <div field="StartTime" width="120" headeralign="center" allowsort="true">开始时间</div>
                                <div field="EndTime" width="120" headeralign="center" allowsort="true">截止时间</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="text-align: center; padding: 5px;">
                    <a class="mini-button" onclick="SaveAccessData('AccessSubmit')"  style="width: 60px; margin-right: 20px;">确定</a>
                    <a class="mini-button" onclick="onCancel" style="width: 60px;">取消</a>
                </div>
            </div>

        </div>
    </div>
</body>
<script type="text/javascript">

    mini.parse();
    ////////////////////
    //加载窗口信息
    function Show(data) {
        //跨页面传递的数据对象，克隆后才可以安全使用
        receiveData = mini.clone(data);
        var treeGrid = mini.get("#treegrid1");
        //treeGrid.load("../Test/tasks.txt");
        treeGrid.load("LoadAddAccessDetail?selectedID=" + receiveData.id);

        var devicetreeGrid = mini.get("#devicetreegrid");
        devicetreeGrid.load("LoadDeviceTreeList?selectedID=" + receiveData.id);
    }
    function SaveAccessData(type) {
        //获取操作类型（新建/修改）
        var url;
        if (type == 'AccessSubmit') {
            //新建
            url = "../AccessManage/AddAccessOfAccess?accessID=" + receiveData.id;
            var treeGrid = mini.get("#treegrid1");
            var node = treeGrid.getSelectedNode();
            var json = mini.encode(node);
            alert(json);
        }
        else if (type == 'datetime') {
            //编辑
            url = "/AccessManage/updateDateTimeOfAccess";
        }
        if ((node) && (node.Pid == "0")) {
            //var json = mini.encode(o);
            $.ajax({
                url: url,
                type: 'post',
                data: { data: json },
                cache: false,
                success: function (text) {

                    if (text == "Success") {
                        mini.alert("修改成功！");
                        CloseWindow("save");
                    }
                    else {
                        alert(text);
                    }
                },
                error: function (jqXHR, textStatus, errorThrown) {
                    alert(jqXHR.responseText);
                    CloseWindow();
                }
            });
        }
        else {
            alert("请选中一个根节点");
        }
    }

    function CloseWindow(action) {
        if (window.CloseOwnerWindow) return window.CloseOwnerWindow(action);
        else window.close();
    }

    function onCancel(e) {
        CloseWindow("cancel");
    }
</script>

</html>
